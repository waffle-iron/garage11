/*!
* js-data-localstorage
* @version 2.1.3 - Homepage <http://www.js-data.io/docs/dslocalstorageadapter>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2015 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-localstorage/blob/master/LICENSE>
*
* @overview localStorage adapter for js-data.
*/
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("js-data")):"function"==typeof define&&define.amd?define(["js-data"],e):"object"==typeof exports?exports.DSLocalStorageAdapter=e(require("js-data")):t.DSLocalStorageAdapter=e(t.JSData)}(this,function(t){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t){m.push(t)}function u(){m.length&&!b&&(b=!0,m[0]())}function a(t){m.length?i(t):(i(t),u())}function c(t){return new v.Promise(t).then(function(t){return b=!1,m.shift(),setTimeout(u,0),t},function(t){return b=!1,m.shift(),setTimeout(u,0),v.Promise.reject(t)})}var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),f=n(1),s=n(2),h=n(13),d=n(22),p=new f.DS,v=f.DSUtils,y=p.defaults.defaultFilter,g=function t(){o(this,t)};g.prototype.basePath="";var m=[],b=!1,w=function(){function t(e){o(this,t),e=e||{},this.defaults=new g,v.deepMixIn(this.defaults,e)}return l(t,[{key:"getPath",value:function(t,e){return v.makePath(e.basePath||this.defaults.basePath||t.basePath,t.name)}},{key:"getIdPath",value:function(t,e,n){return v.makePath(e.basePath||this.defaults.basePath||t.basePath,t.endpoint,n)}},{key:"getIds",value:function(t,e){var n=void 0,r=this.getPath(t,e),o=localStorage.getItem(r);return o?n=v.fromJson(o):(localStorage.setItem(r,v.toJson({})),n={}),n}},{key:"saveKeys",value:function(t,e,n){localStorage.setItem(this.getPath(e,n),v.toJson(t))}},{key:"ensureId",value:function(t,e,n){var r=this.getIds(e,n);r[t]=1,this.saveKeys(r,e,n)}},{key:"removeId",value:function(t,e,n){var r=this.getIds(e,n);delete r[t],this.saveKeys(r,e,n)}},{key:"GET",value:function(t){return new v.Promise(function(e){var n=localStorage.getItem(t);e(n?v.fromJson(n):void 0)})}},{key:"PUT",value:function(t,e){var n=this;return n.GET(t).then(function(r){return r&&v.deepMixIn(r,v.removeCircular(e)),localStorage.setItem(t,v.toJson(r||e)),n.GET(t)})}},{key:"DEL",value:function(t){return new v.Promise(function(e){localStorage.removeItem(t),e()})}},{key:"find",value:function(t,e,n){var o=this,i=void 0;return n=n||{},n.with=n.with||[],new v.Promise(function(u,a){o.GET(o.getIdPath(t,n||{},e)).then(function(t){return t?t:a(new Error("Not Found!"))}).then(function(e){i=e;var u=[];return v.forEach(t.relationList,function(e){var a=e.relation,c=t.getResource(a),l=null;v.contains(n.with,a)?l=a:v.contains(n.with,e.localField)&&(l=e.localField),l&&!function(){var f=v.deepMixIn({},n.orig?n.orig():n);f.with=n.with.slice(),f=v._(c,f),v.remove(f.with,l),v.forEach(f.with,function(t,e){t&&0===t.indexOf(l)&&t.length>=l.length&&"."===t[l.length]?f.with[e]=t.substr(l.length+1):f.with[e]=""});var s=void 0;if("hasOne"!==e.type&&"hasMany"!==e.type||!e.foreignKey)if("hasMany"===e.type&&e.localKeys){var d=[],p=i[e.localKeys]||[];p=Array.isArray(p)?p:v.keys(p),d=d.concat(p||[]),s=o.findAll(t.getResource(a),{where:r({},c.idAttribute,{in:v.filter(h(d),function(t){return t})})},f).then(function(t){return v.set(i,e.localField,t),t})}else("belongsTo"===e.type||"hasOne"===e.type&&e.localKey)&&(s=o.find(t.getResource(a),v.get(i,e.localKey),f).then(function(t){return v.set(i,e.localField,t),t}));else s=o.findAll(t.getResource(a),{where:r({},e.foreignKey,{"==":i[t.idAttribute]})},f).then(function(t){return"hasOne"===e.type&&t.length?v.set(i,e.localField,t[0]):v.set(i,e.localField,t),t});s&&u.push(s)}()}),v.Promise.all(u)}).then(function(){return u(i)}).catch(a)})}},{key:"findAll",value:function(t,e,n){var o=this,i=null;return n=n||{},n.with=n.with||[],new v.Promise(function(r,i){try{!function(){n=n||{},"allowSimpleWhere"in n||(n.allowSimpleWhere=!0);var i=[],u=v.keys(o.getIds(t,n));v.forEach(u,function(e){var r=localStorage.getItem(o.getIdPath(t,n,e));r&&i.push(v.fromJson(r))}),r(y.call(p,i,t.name,e,n))}()}catch(t){i(t)}}).then(function(e){i=e;var u=[];return v.forEach(t.relationList,function(e){var a=e.relation,c=t.getResource(a),l=null;v.contains(n.with,a)?l=a:v.contains(n.with,e.localField)&&(l=e.localField),l&&!function(){var f=v.deepMixIn({},n.orig?n.orig():n);f.with=n.with.slice(),f=v._(c,f),v.remove(f.with,l),v.forEach(f.with,function(t,e){t&&0===t.indexOf(l)&&t.length>=l.length&&"."===t[l.length]?f.with[e]=t.substr(l.length+1):f.with[e]=""});var s=void 0;"hasOne"!==e.type&&"hasMany"!==e.type||!e.foreignKey?"hasMany"===e.type&&e.localKeys?!function(){var n=[];v.forEach(i,function(t){var r=t[e.localKeys]||[];r=Array.isArray(r)?r:v.keys(r),n=n.concat(r||[])}),s=o.findAll(t.getResource(a),{where:r({},c.idAttribute,{in:v.filter(h(n),function(t){return t})})},f).then(function(t){return v.forEach(i,function(n){var r=[],o=n[e.localKeys]||[];o=Array.isArray(o)?o:v.keys(o),v.forEach(t,function(t){o&&v.contains(o,t[c.idAttribute])&&r.push(t)}),v.set(n,e.localField,r)}),t})}():("belongsTo"===e.type||"hasOne"===e.type&&e.localKey)&&(s=o.findAll(t.getResource(a),{where:r({},c.idAttribute,{in:v.filter(d(i,function(t){return v.get(t,e.localKey)}),function(t){return t})})},f).then(function(t){return v.forEach(i,function(n){v.forEach(t,function(t){t[c.idAttribute]===n[e.localKey]&&v.set(n,e.localField,t)})}),t})):s=o.findAll(t.getResource(a),{where:r({},e.foreignKey,{in:v.filter(d(i,function(e){return v.get(e,t.idAttribute)}),function(t){return t})})},f).then(function(n){return v.forEach(i,function(r){var o=[];v.forEach(n,function(n){v.get(n,e.foreignKey)===r[t.idAttribute]&&o.push(n)}),"hasOne"===e.type&&o.length?v.set(r,e.localField,o[0]):v.set(r,e.localField,o)}),n}),s&&u.push(s)}()}),v.Promise.all(u)}).then(function(){return i})}},{key:"create",value:function(t,e,n){var r=this;return c(function(o,i){a(function(){e[t.idAttribute]=e[t.idAttribute]||s(),n=n||{},r.PUT(v.makePath(r.getIdPath(t,n,e[t.idAttribute])),v.omit(e,t.relationFields||[])).then(function(e){r.ensureId(e[t.idAttribute],t,n),o(e)}).catch(i)})})}},{key:"update",value:function(t,e,n,r){var o=this;return c(function(i,u){a(function(){r=r||{},o.PUT(o.getIdPath(t,r,e),v.omit(n,t.relationFields||[])).then(function(e){o.ensureId(e[t.idAttribute],t,r),i(e)}).catch(u)})})}},{key:"updateAll",value:function(t,e,n,r){var o=this;return this.findAll(t,n,r).then(function(n){var i=[];return v.forEach(n,function(n){return i.push(o.update(t,n[t.idAttribute],v.omit(e,t.relationFields||[]),r))}),v.Promise.all(i)})}},{key:"destroy",value:function(t,e,n){var r=this;return c(function(o,i){a(function(){n=n||{},r.DEL(r.getIdPath(t,n,e)).then(function(){return r.removeId(e,t.name,n)}).then(function(){return o(null)},i)})})}},{key:"destroyAll",value:function(t,e,n){var r=this;return this.findAll(t,e,n).then(function(e){var o=[];return v.forEach(e,function(e){return o.push(r.destroy(t,e[t.idAttribute],n))}),v.Promise.all(o)})}}]),t}();w.version={full:"<%= pkg.version %>",major:parseInt("<%= major %>",10),minor:parseInt("<%= minor %>",10),patch:parseInt("<%= patch %>",10),alpha:"<%= alpha %>",beta:"<%= beta %>"},t.exports=w},function(e,n){e.exports=t},function(t,e,n){function r(){return o(8)+"-"+o(4)+"-4"+o(3)+"-"+i(8,9,"a","b")+o(3)+"-"+o(12)}var o=n(3),i=n(4);t.exports=r},function(t,e,n){function r(t){t=t&&t>0?t:6;for(var e="";t--;)e+=o(i);return e}var o=n(4),i="0123456789abcdef".split("");t.exports=r},function(t,e,n){function r(t){var e=1===arguments.length&&i(t)?t:arguments;return e[o(0,e.length-1)]}var o=n(5),i=n(10);t.exports=r},function(t,e,n){function r(t,e){return t=null==t?o:~~t,e=null==e?i:~~e,Math.round(u(t-.5,e+.499999999999))}var o=n(6),i=n(7),u=n(8);t.exports=r},function(t,e){t.exports=-2147483648},function(t,e){t.exports=2147483647},function(t,e,n){function r(t,e){return t=null==t?i:t,e=null==e?u:e,t+(e-t)*o()}var o=n(9),i=n(6),u=n(7);t.exports=r},function(t,e){function n(){return n.get()}n.get=Math.random,t.exports=n},function(t,e,n){var r=n(11),o=Array.isArray||function(t){return r(t,"Array")};t.exports=o},function(t,e,n){function r(t,e){return o(t)===e}var o=n(12);t.exports=r},function(t,e){function n(t){return null===t?"Null":t===r?"Undefined":o.exec(i.call(t))[1]}var r,o=/^\[object (.*)\]$/,i=Object.prototype.toString;t.exports=n},function(t,e,n){function r(t,e){return e=e||o,i(t,function(t,n,r){for(var o=r.length;++n<o;)if(e(t,r[n]))return!1;return!0})}function o(t,e){return t===e}var i=n(14);t.exports=r},function(t,e,n){function r(t,e,n){e=o(e,n);var r=[];if(null==t)return r;for(var i,u=-1,a=t.length;++u<a;)i=t[u],e(i,u,t)&&r.push(i);return r}var o=n(15);t.exports=r},function(t,e,n){function r(t,e){if(null==t)return o;switch(typeof t){case"function":return"undefined"!=typeof e?function(n,r,o){return t.call(e,n,r,o)}:t;case"object":return function(e){return u(e,t)};case"string":case"number":return i(t)}}var o=n(16),i=n(17),u=n(18);t.exports=r},function(t,e){function n(t){return t}t.exports=n},function(t,e){function n(t){return function(e){return e[t]}}t.exports=n},function(t,e,n){function r(t,e){for(var n=-1,r=t.length;++n<r;)if(u(t[n],e))return!0;return!1}function o(t,e){for(var n=-1,o=e.length;++n<o;)if(!r(t,e[n]))return!1;return!0}function i(t,e){var n=!0;return a(e,function(e,r){return u(t[r],e)?void 0:n=!1}),n}function u(t,e){return t&&"object"==typeof t?c(t)&&c(e)?o(t,e):i(t,e):t===e}var a=n(19),c=n(10);t.exports=u},function(t,e,n){function r(t,e,n){i(t,function(r,i){return o(t,i)?e.call(n,t[i],i,t):void 0})}var o=n(20),i=n(21);t.exports=r},function(t,e){function n(t,e){return Object.prototype.hasOwnProperty.call(t,e)}t.exports=n},function(t,e,n){function r(){a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],u=!0;for(var t in{toString:null})u=!1}function o(t,e,n){var o,l=0;null==u&&r();for(o in t)if(i(e,t,o,n)===!1)break;if(u)for(var f=t.constructor,s=!!f&&t===f.prototype;(o=a[l++])&&("constructor"===o&&(s||!c(t,o))||t[o]===Object.prototype[o]||i(e,t,o,n)!==!1););}function i(t,e,n,r){return t.call(r,e[n],n,e)}var u,a,c=n(20);t.exports=o},function(t,e,n){function r(t,e,n){e=o(e,n);var r=[];if(null==t)return r;for(var i=-1,u=t.length;++i<u;)r[i]=e(t[i],i,t);return r}var o=n(15);t.exports=r}])});
